#!/bin/sh

# Constants
MARKER="â˜…"
COLOR_YELLOW="\033[33m"
COLOR_RESET="\033[0m"
BOOKMARKS_DIR="$HOME/.config/bookmarks"
SEARCH_URL="https://duckduckgo.com/?q="

# Deduplication awk script
dedup_awk='
  {
    orig = $0
    norm = $0
    sub(/^http:/, "https:", norm)
    sub(/^https?:\/\/www\./, "https://", norm)
    sub(/^https?:\/\//, "https://", norm)
    if (!(norm in seen) || (orig ~ /^https:\/\// && orig !~ /\/\/www\./)) {
      seen[norm] = orig
    }
  }
  END {
    for (u in seen) print seen[u]
  }
'

# Detect which browser to use (priority: Brave > Chromium > Firefox > Qutebrowser)
detect_browser() {
  if command -v brave >/dev/null 2>&1; then
    if [ -d "$HOME/.config/BraveSoftware/Brave-Browser/Default" ]; then
      echo "brave"
      return
    fi
  fi

  if command -v chromium >/dev/null 2>&1; then
    if [ -d "$HOME/.config/chromium/Default" ]; then
      echo "chromium"
      return
    fi
  fi

  if command -v firefox >/dev/null 2>&1; then
    if [ -f "$HOME/.mozilla/firefox/profiles.ini" ]; then
      echo "firefox"
      return
    fi
  fi

  if command -v qutebrowser >/dev/null 2>&1; then
    if [ -d "$HOME/.local/share/qutebrowser" ]; then
      echo "qutebrowser"
      return
    fi
  fi

  echo "none"
}

# Collect bookmarks from ~/.config/bookmarks/
collect_bookmarks() {
  find "$BOOKMARKS_DIR/" -type f -exec awk "NF && \$1!=\"\" {print \"$COLOR_YELLOW$MARKER$COLOR_RESET \" \$1}" {} + 2>/dev/null
}

# Collect Firefox history
collect_firefox() {
  local config="$HOME/.mozilla/firefox"
  local profiles="$config/profiles.ini"
  [ -f "$profiles" ] || return
  local file="$config/$(grep Default "$profiles" | head -n1 | cut -d= -f2)/places.sqlite"
  [ -f "$file" ] || return

  sqlite3 "file:$file?immutable=1" "SELECT url FROM moz_places WHERE url NOT NULL ORDER BY last_visit_date DESC" 2>/dev/null | awk 'NF && $1!=""'
}

# Collect Qutebrowser history
collect_qutebrowser() {
  local file="$HOME/.local/share/qutebrowser/history.sqlite"
  [ -f "$file" ] || return

  sqlite3 "file:$file?immutable=1" "SELECT url FROM CompletionHistory ORDER BY last_atime DESC" 2>/dev/null | awk 'NF && $1!=""'
}

# Collect Brave history
collect_brave() {
  local file="$HOME/.config/BraveSoftware/Brave-Browser/Default/History"
  [ -f "$file" ] || return

  sqlite3 "file:$file?immutable=1" "SELECT url FROM urls ORDER BY last_visit_time DESC" 2>/dev/null | awk 'NF && $1!=""'
}

# Collect Chromium history
collect_chromium() {
  local file="$HOME/.config/chromium/Default/History"
  [ -f "$file" ] || return

  sqlite3 "file:$file?immutable=1" "SELECT url FROM urls ORDER BY last_visit_time DESC" 2>/dev/null | awk 'NF && $1!=""'
}

# Preview function - fetch title from web or show URL
preview_func='
  local url={2}
  local title

  # Fetch title from web
  title=$(lynx -dump -source "$url" 2>/dev/null | xmllint --html --xpath '\''//title/text()'\'' - 2>/dev/null)

  # Fallback: show URL
  if [ -z "$title" ]; then
    title="$url"
  fi

  printf "%s\n" "$title" | awk '\''{$1=$1;print}'\''
'

# Detect browser
BROWSER=$(detect_browser)

if [ "$BROWSER" = "none" ]; then
  echo "Error: No supported browser found" >&2
  exit 1
fi

# Build menu and get selected URL
url=$(
  {
    collect_bookmarks
    {
      collect_firefox
      collect_qutebrowser
      collect_brave
      collect_chromium
    } | awk "$dedup_awk"
  } | fzfmenu "$@" \
    --ansi \
    --bind="ctrl-s:print-query" \
    --header='<ctrl-s> to search, <ctrl-y> to copy to clipboard' \
    --preview="$preview_func" \
    --preview-window=down,2,wrap
)

# Strip marker if present
url=$(printf '%s' "$url" | sed "s/^$MARKER //")

# Exit if no selection
[ -n "$url" ] || exit 1

# If input does not look like a URL, search it
is_url_regex='^[a-zA-Z][a-zA-Z0-9+.-]*://|^www\.|^about:'
if ! printf '%s' "$url" | grep -qE "$is_url_regex"; then
  url="${SEARCH_URL}$(printf '%s' "$url" | jq -sRr @uri)"
fi

# Launch with appropriate browser and flags
case "$BROWSER" in
  brave)
    exec brave --app="$url"
    ;;
  chromium)
    exec chromium --app="$url"
    ;;
  firefox)
    exec firefox --fullscreen --new-window "$url"
    ;;
  qutebrowser)
    exec qutebrowser --target window "$url"
    ;;
esac

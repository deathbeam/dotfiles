#!/bin/sh

FILE_ARGS=$(mktemp -u /tmp/fzfmenu_args.XXXXXX)
FILE_CHOICES=$(mktemp /tmp/fzfmenu_choices.XXXXXX)
FEEDER_PID=""
TITLE=""
TERM_CLASS="--class"
if [ "$TERMINAL" = "st" ]; then
   TERM_CLASS="-n"
elif [ "$TERMINAL" = "foot" ] || [ "$TERMINAL" = "footclient" ]; then
   TERM_CLASS="-a"
fi

kill_old() {
  mypid=$$
  same=""
  others=""
  while read -r pid cmdline; do
    [ "$pid" = "$mypid" ] && continue
    if echo "$cmdline" | grep -q -- "-p $TITLE"; then
      same="$pid"
    else
      others="$others $pid"
    fi
  done < <(pgrep -af fzfmenu)
  [ -n "$same" ] && kill "$same" && exit 0
  [ -n "$others" ] && kill $others
}

scan_args() {
  cat > "$FILE_ARGS"
}

show() {
  cat "$FILE_CHOICES";
}

run_menu() {
  # Kill existing instances of menu
  kill_old
  # Create named pipe for streaming
  mkfifo "$FILE_ARGS"
  # Start writer in background
  scan_args &
  FEEDER_PID=$!
  # Start the menu (reader)
  prompt "$@"
  # Wait for feeder to finish and clean up
  wait $FEEDER_PID 2>/dev/null
  show
}

prompt() {
  $TERMINAL $TERM_CLASS shellmenu -T "$TITLE" \
    -e "$SHELL" -c "
      exec fzf \
          --no-border \
          --margin 0,0 \
          --preview-window=border-sharp:wrap \
          --no-separator \
          --info=inline-right \
          --cycle \
          --print-query \
          --no-multi \
          --reverse \
          --bind 'ctrl-y:execute(echo {} | wl-copy)+abort' \
          --header='<ctrl-y> to copy to clipboard' \
          $PROMPT $QUERY $@ < $FILE_ARGS | tail -n 1 >! $FILE_CHOICES
  " &
  pid=$!
  trap "kill -TERM $pid $FEEDER_PID 2>/dev/null" SIGTERM
  wait $pid
  [ -s "$FILE_CHOICES" ] || exit 1
}

main() {
  while :; do
    case $1 in
      -l) shift ;;
      -p) shift && TITLE="$1" && PROMPT="--prompt \"$1 > \"" ;;
      -q) shift && QUERY="-q \"$1\"" ;;
      *) break ;;
    esac
    shift
  done
  quoted_args=""
  if [ $# -gt 0 ]; then
    quoted_args="$(printf "%q " "$@")"
  fi
  run_menu "$quoted_args"
}

trap 'rm -f "$FILE_ARGS" "$FILE_CHOICES"' EXIT
main "$@"

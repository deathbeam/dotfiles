#!/bin/sh
# menu-firefox

FF_PROFILE="$HOME/.config/mozilla/firefox/$(grep Default ~/.config/mozilla/firefox/profiles.ini | head -n1 | cut -d= -f2)"
PLACES="file:$FF_PROFILE/places.sqlite?immutable=1"

# Get bookmarks (unique URLs)
bookmarks="SELECT DISTINCT url FROM moz_bookmarks JOIN moz_places ON moz_bookmarks.fk=moz_places.id WHERE url NOT NULL"

# Get recent history (limit to 1000)
history="SELECT url FROM moz_places WHERE url NOT NULL ORDER BY last_visit_date DESC LIMIT 1000"

# Combine bookmarks and history, remove duplicates, and filter out empty lines
urls=$(sqlite3 "$PLACES" "$bookmarks; $history" 2>/dev/null | awk 'NF' | awk '!seen[$0]++')

# Use fzfmenu for selection
url=$(printf '%s\n' "$urls" | "$HOME/.local/bin/fzfmenu" "$@" \
    --bind="ctrl-s:print-query" \
    --header='<ctrl-s> to search, <ctrl-y> to copy to clipboard' \
)
[ -n "$url" ] || exit 1

# If input does not look like a URL, search it
if ! printf '%s' "$url" | grep -qE '^[a-zA-Z][a-zA-Z0-9+.-]*://|^www\.'; then
  url="https://duckduckgo.com/?q=$(printf '%s' "$url" | jq -sRr @uri)"
fi

exec firefox --fullscreen --new-window "$url"

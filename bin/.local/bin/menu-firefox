#!/bin/sh
# menu-firefox

FF_PROFILE="$HOME/.config/mozilla/firefox/$(grep Default ~/.config/mozilla/firefox/profiles.ini | head -n1 | cut -d= -f2)"
PLACES="file:$FF_PROFILE/places.sqlite?immutable=1"

# Get bookmarks (url only)
bookmarks="SELECT DISTINCT url FROM moz_bookmarks JOIN moz_places ON moz_bookmarks.fk=moz_places.id WHERE url NOT NULL"

# Get recent history (url only)
history="SELECT url FROM moz_places WHERE url NOT NULL ORDER BY last_visit_date DESC"

# Deduplicate: prefer https over http
dedup_awk='
  {
    orig = $0
    norm = $0
    sub(/^http:/, "https:", norm)
    sub(/^https?:\/\/www\./, "https://", norm)
    sub(/^https?:\/\//, "https://", norm)
    if (!(norm in seen)) {
      seen[norm] = orig
    } else {
      # Prefer https and non-www if available
      if (orig ~ /^https:\/\// && orig !~ /\/\/www\./) {
        seen[norm] = orig
      }
    }
  }
  END {
    for (u in seen) print seen[u]
  }
'

# Use fzfmenu for selection, streaming results as they are generated
url=$(
  fzfmenu "$@" \
    --bind="ctrl-s:print-query" \
    --header='<ctrl-s> to search, <ctrl-y> to copy to clipboard' \
    --preview="title=\$(sqlite3 '$PLACES' \"SELECT title FROM moz_places WHERE url={1}\"); [ -n \"\$title\" ] && echo \"\$title\" || echo \"{1}\"" \
    --preview-window=down,3,wrap \
    < <(
      sqlite3 "$PLACES" "$bookmarks; $history" 2>/dev/null | awk 'NF && $1!=""' | awk "$dedup_awk"
    )
)
[ -n "$url" ] || exit 1

# If input does not look like a URL, search it
is_url_regex='^[a-zA-Z][a-zA-Z0-9+.-]*://|^www\.|^about:'
if ! printf '%s' "$url" | grep -qE "$is_url_regex"; then
  url="https://duckduckgo.com/?q=$(printf '%s' "$url" | jq -sRr @uri)"
fi

exec firefox --fullscreen --new-window "$url"

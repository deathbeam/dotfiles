#!/bin/sh
# menu-firefox

FF_PROFILE="$HOME/.config/mozilla/firefox/$(grep Default ~/.config/mozilla/firefox/profiles.ini | head -n1 | cut -d= -f2)"
PLACES="file:$FF_PROFILE/places.sqlite?immutable=1"

# Get bookmarks (url only)
bookmarks="SELECT DISTINCT url FROM moz_bookmarks JOIN moz_places ON moz_bookmarks.fk=moz_places.id WHERE url NOT NULL"

# Get recent history (url only)
history="SELECT url FROM moz_places WHERE url NOT NULL ORDER BY last_visit_date DESC"

# Deduplicate: prefer https over http
dedup_awk='
  /^https:\/\// { https[$0]=1 }
  /^http:\/\// { http[$0]=1 }
  END {
    for (u in https) print u
    for (u in http) {
      alt = u
      sub(/^http:/, "https:", alt)
      if (!(alt in https)) print u
    }
  }
'

# Use fzfmenu for selection, streaming results as they are generated
url=$(
  fzfmenu "$@" \
    --bind="ctrl-s:print-query" \
    --header='<ctrl-s> to search, <ctrl-y> to copy to clipboard' \
    < <(
      sqlite3 "$PLACES" "$bookmarks; $history" 2>/dev/null | awk 'NF && $1!=""' | awk "$dedup_awk"
    )
)
url=$(echo "$url" | xargs)  # trim whitespace
[ -n "$url" ] || exit 1

# If input does not look like a URL, search it
is_url_regex='^[a-zA-Z][a-zA-Z0-9+.-]*://|^www\.|^about:'
if ! printf '%s' "$url" | grep -qE "$is_url_regex"; then
  url="https://duckduckgo.com/?q=$(printf '%s' "$url" | jq -sRr @uri)"
fi

exec firefox --fullscreen --new-window "$url"
